<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventarios</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #28a745;
      --secondary-color: #218838;
      --text-dark: #2b2d42;
      --text-light: #8d99ae;
      --card-bg: rgba(255,255,255,0.95);
    }
    * { box-sizing: border-box; }
    body {
      background: #f0f2f5;
      background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%),
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%),
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-attachment: fixed;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      color: var(--text-dark);
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
    h2 { color: #1a1a1a; font-size: 1.8em; margin: 0; font-weight: 700; }
    .back-link { color: var(--text-light); text-decoration: none; font-weight: 600; padding: 8px 12px; }
    .back-link:hover { color: var(--primary-color); }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; }
    .tab-btn { padding: 10px 20px; border: none; background: #f0f0f0; border-radius: 10px 10px 0 0; cursor: pointer; font-weight: 600; font-family: inherit; }
    .tab-btn.active { background: var(--primary-color); color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .scanner-section { background: rgba(40,167,69,0.05); border: 1px solid rgba(40,167,69,0.15); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    .scanner-section h3 { margin: 0 0 10px 0; color: var(--primary-color); font-size: 1em; }
    .scanner-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
    #scanner-video { width: 100%; max-width: 350px; border-radius: 10px; display: none; }
    .scan-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
    .scan-inputs label { font-weight: 600; font-size: 0.85em; display: block; margin-bottom: 3px; }
    .scan-inputs input { width: 100%; padding: 8px 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; font-family: inherit; }
    .scan-inputs input:focus { border-color: var(--primary-color); outline: none; }
    button { background: linear-gradient(45deg, #28a745, #218838); color: #fff; border: none; border-radius: 8px; padding: 8px 16px; font-size: 0.9em; font-weight: 600; cursor: pointer; font-family: inherit; }
    button:hover { opacity: 0.9; }
    button.secondary { background: linear-gradient(45deg, #4361ee, #3f37c9); }
    button.danger { background: linear-gradient(45deg, #dc3545, #c82333); }
    button.toggle-true { background: #28a745; padding: 4px 10px; font-size: 0.8em; }
    button.toggle-false { background: #dc3545; padding: 4px 10px; font-size: 0.8em; }
    button.sm { padding: 4px 10px; font-size: 0.8em; }
    .table-container { overflow-x: auto; margin-top: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; background: white; }
    thead { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; }
    th { padding: 10px 8px; text-align: center; font-weight: 600; font-size: 0.8em; white-space: nowrap; }
    td { padding: 8px 6px; border-bottom: 1px solid #e9ecef; font-size: 0.8em; text-align: center; }
    td input { width: 100%; padding: 5px 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85em; }
    tbody tr:hover { background-color: rgba(40,167,69,0.03); }
    .msg { padding: 12px; border-radius: 10px; margin: 10px 0; text-align: center; font-weight: 500; display: none; }
    .msg.success { color: #28a745; background: rgba(40,167,69,0.1); }
    .msg.error { color: #dc3545; background: rgba(220,53,69,0.1); }
    .loading { text-align: center; padding: 30px; color: var(--text-light); }
    .info-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    .info-badge { background: rgba(40,167,69,0.1); padding: 6px 14px; border-radius: 15px; font-size: 0.85em; color: var(--primary-color); font-weight: 600; }
    .search-input { width: 100%; max-width: 350px; padding: 10px 14px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 0.95em; font-family: inherit; }
    .search-input:focus { border-color: var(--primary-color); outline: none; }
    .action-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
    .download-link { display: inline-block; color: var(--primary-color); font-weight: 600; text-decoration: none; padding: 8px 16px; border: 2px solid var(--primary-color); border-radius: 8px; font-size: 0.9em; }
    .download-link:hover { background: var(--primary-color); color: white; }
    .pagination { display: flex; gap: 5px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    .pagination button { min-width: 35px; }
    .pagination button.active { background: var(--secondary-color); }
    @media (max-width: 768px) {
      .container { padding: 15px; }
      h2 { font-size: 1.4em; }
      th, td { padding: 6px 4px; font-size: 0.7em; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAkqr6RyXUHMHp3NtWrgsn-T6wj_tHQI00",
      authDomain: "supratechweb.firebaseapp.com",
      projectId: "supratechweb",
      storageBucket: "supratechweb.firebasestorage.app",
      messagingSenderId: "828253545658",
      appId: "1:828253545658:web:daa886d1de6c9c796a8e83"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <div class="container">
    <a href="/panel" class="back-link">&larr; Volver</a>
    <div class="header"><h2>Inventarios</h2></div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="inventario">Inventario</button>
      <button class="tab-btn" data-tab="surtible">Surtible</button>
    </div>

    <div id="msg" class="msg"></div>

    <!-- Tab Inventario -->
    <div id="tab-inventario" class="tab-content active">
      <div class="scanner-section">
        <h3>Escanear Codigo de Barras</h3>
        <div class="scanner-controls">
          <button id="start-scanner">Iniciar Camara</button>
          <button id="stop-scanner" style="display:none;">Detener</button>
          <span style="color:#666;font-size:0.85em;">o usa escaner USB</span>
        </div>
        <video id="scanner-video" autoplay playsinline></video>
        <div class="scan-inputs">
          <div><label>Estante</label><input type="text" id="scan-estante" placeholder="A1"></div>
          <div><label>Nivel</label><input type="text" id="scan-nivel" placeholder="1"></div>
          <div><label>Codigo</label><input type="text" id="scan-codigo" placeholder="Escanea aqui" autofocus></div>
          <div style="display:flex;align-items:flex-end;"><button id="btn-guardar-escaneo">Guardar</button></div>
        </div>
      </div>

      <div class="action-row">
        <a href="/static/plantilla_inventario.csv" download class="download-link">Plantilla CSV</a>
        <input type="file" id="csv-file" accept=".csv" style="display:none;">
        <button class="secondary" id="btn-cargar-csv">Cargar CSV</button>
        <button class="danger" id="btn-borrar">Borrar datos</button>
      </div>

      <div class="info-row">
        <span class="info-badge" id="total-inventario">Total: --</span>
        <input type="text" class="search-input" id="search-inventario" placeholder="Buscar...">
      </div>

      <div id="loading-inventario" class="loading">Cargando...</div>
      <div class="table-container" id="table-inventario" style="display:none;">
        <table>
          <thead><tr><th>Estante</th><th>Nivel</th><th>Codigo</th><th>PICKING</th><th>SKU</th><th>Titulo</th><th>Marca</th><th>MOSTRADOR</th><th></th></tr></thead>
          <tbody id="tbody-inventario"></tbody>
        </table>
      </div>
      <div class="pagination" id="pag-inventario"></div>
    </div>

    <!-- Tab Surtible -->
    <div id="tab-surtible" class="tab-content">
      <div class="action-row">
        <button class="secondary" id="btn-descargar-excel">Descargar Excel</button>
      </div>
      <div class="info-row">
        <span class="info-badge" id="total-surtible">Total: --</span>
        <input type="text" class="search-input" id="search-surtible" placeholder="Buscar...">
      </div>
      <div id="loading-surtible" class="loading">Cargando...</div>
      <div class="table-container" id="table-surtible" style="display:none;">
        <table>
          <thead><tr><th>SKU</th><th>Unidades</th><th>Unidades 2</th><th>SKU Original</th><th>Marca</th></tr></thead>
          <tbody id="tbody-surtible"></tbody>
        </table>
      </div>
      <div class="pagination" id="pag-surtible"></div>
    </div>
  </div>

<script>
(function() {
  let idToken = null;
  let inventarioData = [], surtibleData = [];
  let filteredInv = [], filteredSurt = [];
  let codeReader = null;
  let surtibleLoaded = false;
  const PAGE_SIZE = 50;
  let pageInv = 1, pageSurt = 1;

  // Cache DOM elements
  const $ = id => document.getElementById(id);
  const tbody_inv = $('tbody-inventario');
  const tbody_surt = $('tbody-surtible');
  const msg = $('msg');

  function showMsg(text, type) {
    msg.textContent = text;
    msg.className = 'msg ' + type;
    msg.style.display = 'block';
    setTimeout(() => msg.style.display = 'none', 3000);
  }

  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = function() {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      this.classList.add('active');
      $('tab-' + this.dataset.tab).classList.add('active');
      if (this.dataset.tab === 'surtible' && !surtibleLoaded) cargarSurtible();
    };
  });

  firebase.auth().onAuthStateChanged(async user => {
    if (user) {
      idToken = await user.getIdToken();
      cargarInventario();
    } else {
      window.location.href = '/';
    }
  });

  // === INVENTARIO ===
  async function cargarInventario() {
    try {
      const res = await fetch('/api/inventarios/inventario/data', { headers: { 'Authorization': 'Bearer ' + idToken } });
      const result = await res.json();
      if (res.ok) {
        inventarioData = result.tabla || [];
        filteredInv = inventarioData;
        $('total-inventario').textContent = 'Total: ' + inventarioData.length;
        pageInv = 1;
        renderInventario();
        $('loading-inventario').style.display = 'none';
        $('table-inventario').style.display = 'block';
      } else showMsg(result.error || 'Error', 'error');
    } catch (e) { showMsg('Error: ' + e.message, 'error'); }
  }

  function renderInventario() {
    const start = (pageInv - 1) * PAGE_SIZE;
    const pageData = filteredInv.slice(start, start + PAGE_SIZE);
    const frag = document.createDocumentFragment();

    if (pageData.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="9" style="padding:20px;">No hay datos</td>';
      frag.appendChild(tr);
    } else {
      pageData.forEach((row, i) => {
        const idx = start + i;
        const tr = document.createElement('tr');
        tr.dataset.idx = idx;
        const pick = row[3] === 'true' || row[3] === true;
        const most = row[7] === 'true' || row[7] === true;
        tr.innerHTML = `
          <td><input type="text" value="${row[0]||''}" data-col="0"></td>
          <td><input type="text" value="${row[1]||''}" data-col="1"></td>
          <td><input type="text" value="${row[2]||''}" data-col="2"></td>
          <td><button class="${pick?'toggle-true':'toggle-false'}" data-action="pick">${pick?'TRUE':'FALSE'}</button></td>
          <td>${row[4]||''}</td>
          <td>${row[5]||''}</td>
          <td>${row[6]||''}</td>
          <td><button class="${most?'toggle-true':'toggle-false'}" data-action="most">${most?'TRUE':'FALSE'}</button></td>
          <td><button class="sm" data-action="save">Guardar</button></td>`;
        frag.appendChild(tr);
      });
    }
    tbody_inv.innerHTML = '';
    tbody_inv.appendChild(frag);
    renderPagination('pag-inventario', filteredInv.length, pageInv, p => { pageInv = p; renderInventario(); });
  }

  // Event delegation for inventario table
  tbody_inv.onclick = async function(e) {
    const btn = e.target.closest('button');
    if (!btn) return;
    const tr = btn.closest('tr');
    const idx = parseInt(tr.dataset.idx);
    const action = btn.dataset.action;

    if (action === 'pick') {
      const newVal = inventarioData[idx][3] === 'true' || inventarioData[idx][3] === true ? 'false' : 'true';
      btn.disabled = true;
      await actualizarCelda(idx, 'D', newVal);
      inventarioData[idx][3] = newVal;
      btn.className = newVal === 'true' ? 'toggle-true' : 'toggle-false';
      btn.textContent = newVal === 'true' ? 'TRUE' : 'FALSE';
      btn.disabled = false;
    } else if (action === 'most') {
      const newVal = inventarioData[idx][7] === 'true' || inventarioData[idx][7] === true ? 'false' : 'true';
      btn.disabled = true;
      await actualizarCelda(idx, 'H', newVal);
      inventarioData[idx][7] = newVal;
      btn.className = newVal === 'true' ? 'toggle-true' : 'toggle-false';
      btn.textContent = newVal === 'true' ? 'TRUE' : 'FALSE';
      btn.disabled = false;
    } else if (action === 'save') {
      const inputs = tr.querySelectorAll('input');
      const vals = {};
      inputs.forEach(inp => vals[inp.dataset.col] = inp.value);
      btn.disabled = true;
      try {
        const res = await fetch('/api/inventarios/inventario/update_row', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + idToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ row: idx + 2, estante: vals[0], nivel: vals[1], codigo: vals[2] })
        });
        if (res.ok) {
          inventarioData[idx][0] = vals[0];
          inventarioData[idx][1] = vals[1];
          inventarioData[idx][2] = vals[2];
          showMsg('Guardado', 'success');
        } else showMsg('Error', 'error');
      } catch (e) { showMsg('Error', 'error'); }
      btn.disabled = false;
    }
  };

  async function actualizarCelda(rowIdx, col, value) {
    try {
      await fetch('/api/inventarios/inventario/update_cell', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + idToken, 'Content-Type': 'application/json' },
        body: JSON.stringify({ row: rowIdx + 2, col, value })
      });
    } catch (e) { showMsg('Error', 'error'); }
  }

  // Search with debounce
  let searchTimeout;
  $('search-inventario').oninput = function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const term = this.value.toLowerCase();
      filteredInv = term ? inventarioData.filter(r => r.some(c => (c||'').toString().toLowerCase().includes(term))) : inventarioData;
      $('total-inventario').textContent = term ? `Mostrando: ${filteredInv.length} de ${inventarioData.length}` : `Total: ${inventarioData.length}`;
      pageInv = 1;
      renderInventario();
    }, 200);
  };

  // Scanner
  $('start-scanner').onclick = async function() {
    if (!window.ZXing) {
      showMsg('Cargando escaner...', 'success');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/@zxing/library@0.20.0';
      script.onload = startCam;
      document.head.appendChild(script);
    } else startCam();
  };

  async function startCam() {
    try {
      const video = $('scanner-video');
      video.style.display = 'block';
      $('start-scanner').style.display = 'none';
      $('stop-scanner').style.display = 'inline-block';

      // Configurar hints para formatos de codigo de barras comunes
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8,
        ZXing.BarcodeFormat.UPC_A,
        ZXing.BarcodeFormat.UPC_E,
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.CODE_39,
        ZXing.BarcodeFormat.CODE_93,
        ZXing.BarcodeFormat.ITF,
        ZXing.BarcodeFormat.CODABAR
      ]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

      codeReader = new ZXing.BrowserMultiFormatReader(hints);

      // Constraints para camara trasera con alta resolucion
      const constraints = {
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 },
          focusMode: { ideal: 'continuous' }
        }
      };

      // Callback cuando detecta codigo
      const onResult = (result, error) => {
        if (result) {
          const code = result.getText();
          $('scan-codigo').value = code;
          showMsg('Codigo: ' + code, 'success');
          // Vibrar si es posible
          if (navigator.vibrate) navigator.vibrate(100);
        }
      };

      try {
        // Intentar usar constraints directamente
        await codeReader.decodeFromConstraints(constraints, 'scanner-video', onResult);
      } catch (e) {
        console.log('Fallback a seleccion de camara');
        // Fallback: listar camaras y elegir la trasera
        const devices = await codeReader.listVideoInputDevices();
        if (!devices.length) { showMsg('No hay camaras', 'error'); return; }

        // Buscar camara trasera
        let backCamera = devices.find(d => {
          const label = d.label.toLowerCase();
          return label.includes('back') || label.includes('rear') ||
                 label.includes('environment') || label.includes('trasera') ||
                 label.includes('posterior');
        });

        // Si no encuentra por nombre, usar la ultima (suele ser trasera en moviles)
        if (!backCamera && devices.length > 1) backCamera = devices[devices.length - 1];
        if (!backCamera) backCamera = devices[0];

        await codeReader.decodeFromVideoDevice(backCamera.deviceId, 'scanner-video', onResult);
      }

      showMsg('Escaner listo - apunta al codigo de barras', 'success');

    } catch (e) {
      console.error('Error scanner:', e);
      showMsg('Error camara: ' + e.message, 'error');
      $('scanner-video').style.display = 'none';
      $('start-scanner').style.display = 'inline-block';
      $('stop-scanner').style.display = 'none';
    }
  }

  $('stop-scanner').onclick = function() {
    if (codeReader) { codeReader.reset(); codeReader = null; }
    $('scanner-video').style.display = 'none';
    $('start-scanner').style.display = 'inline-block';
    $('stop-scanner').style.display = 'none';
  };

  $('btn-guardar-escaneo').onclick = async function() {
    const estante = $('scan-estante').value;
    const nivel = $('scan-nivel').value;
    const codigo = $('scan-codigo').value;
    if (!codigo) { showMsg('Ingresa codigo', 'error'); return; }
    this.disabled = true;
    try {
      const res = await fetch('/api/inventarios/inventario/registro', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + idToken, 'Content-Type': 'application/json' },
        body: JSON.stringify({ estante, nivel, codigo })
      });
      if (res.ok) {
        showMsg('Guardado', 'success');
        $('scan-codigo').value = '';
        $('scan-codigo').focus();
        cargarInventario();
      } else showMsg('Error', 'error');
    } catch (e) { showMsg('Error', 'error'); }
    this.disabled = false;
  };

  // CSV
  $('btn-cargar-csv').onclick = () => $('csv-file').click();
  $('csv-file').onchange = async function() {
    const file = this.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    try {
      const res = await fetch('/api/inventarios/inventario/bulk', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + idToken },
        body: formData
      });
      const data = await res.json();
      if (res.ok) { showMsg('CSV: ' + data.rows + ' filas', 'success'); cargarInventario(); }
      else showMsg(data.error || 'Error', 'error');
    } catch (e) { showMsg('Error', 'error'); }
    this.value = '';
  };

  $('btn-borrar').onclick = async function() {
    if (!confirm('Borrar todos los datos?')) return;
    try {
      const res = await fetch('/api/inventarios/inventario/clear', { method: 'POST', headers: { 'Authorization': 'Bearer ' + idToken } });
      if (res.ok) { showMsg('Borrado', 'success'); cargarInventario(); }
      else showMsg('Error', 'error');
    } catch (e) { showMsg('Error', 'error'); }
  };

  // === SURTIBLE ===
  async function cargarSurtible() {
    surtibleLoaded = true;
    try {
      const res = await fetch('/api/inventarios/surtible/data', { headers: { 'Authorization': 'Bearer ' + idToken } });
      const result = await res.json();
      if (res.ok) {
        surtibleData = result.tabla || [];
        filteredSurt = surtibleData;
        $('total-surtible').textContent = 'Total: ' + surtibleData.length;
        pageSurt = 1;
        renderSurtible();
        $('loading-surtible').style.display = 'none';
        $('table-surtible').style.display = 'block';
      } else showMsg(result.error || 'Error', 'error');
    } catch (e) { showMsg('Error', 'error'); }
  }

  function renderSurtible() {
    const start = (pageSurt - 1) * PAGE_SIZE;
    const pageData = filteredSurt.slice(start, start + PAGE_SIZE);
    const frag = document.createDocumentFragment();

    if (pageData.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="5" style="padding:20px;">No hay datos</td>';
      frag.appendChild(tr);
    } else {
      pageData.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row[0]||''}</td><td>${row[1]||''}</td><td>${row[2]||''}</td><td>${row[3]||''}</td><td>${row[4]||''}</td>`;
        frag.appendChild(tr);
      });
    }
    tbody_surt.innerHTML = '';
    tbody_surt.appendChild(frag);
    renderPagination('pag-surtible', filteredSurt.length, pageSurt, p => { pageSurt = p; renderSurtible(); });
  }

  $('search-surtible').oninput = function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const term = this.value.toLowerCase();
      filteredSurt = term ? surtibleData.filter(r => r.some(c => (c||'').toString().toLowerCase().includes(term))) : surtibleData;
      $('total-surtible').textContent = term ? `Mostrando: ${filteredSurt.length} de ${surtibleData.length}` : `Total: ${surtibleData.length}`;
      pageSurt = 1;
      renderSurtible();
    }, 200);
  };

  $('btn-descargar-excel').onclick = function() {
    let csv = 'SKU,Unidades a Surtir,Unidades a Surtir 2,SKU Original,Marca\n';
    surtibleData.forEach(row => { csv += row.map(c => '"' + (c||'').toString().replace(/"/g, '""') + '"').join(',') + '\n'; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'surtible_' + new Date().toISOString().slice(0,10) + '.csv';
    link.click();
  };

  // Pagination
  function renderPagination(containerId, total, current, onPage) {
    const container = $(containerId);
    const pages = Math.ceil(total / PAGE_SIZE);
    if (pages <= 1) { container.innerHTML = ''; return; }
    let html = '';
    if (current > 1) html += `<button data-p="${current-1}">&laquo;</button>`;
    const start = Math.max(1, current - 2);
    const end = Math.min(pages, current + 2);
    for (let i = start; i <= end; i++) {
      html += `<button data-p="${i}" class="${i===current?'active':''}">${i}</button>`;
    }
    if (current < pages) html += `<button data-p="${current+1}">&raquo;</button>`;
    container.innerHTML = html;
    container.onclick = e => { if (e.target.dataset.p) onPage(parseInt(e.target.dataset.p)); };
  }

  // USB scanner Enter key
  $('scan-codigo').onkeypress = function(e) {
    if (e.key === 'Enter') { e.preventDefault(); $('btn-guardar-escaneo').click(); }
  };
})();
</script>
</body>
</html>
